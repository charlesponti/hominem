name: type-performance

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - 'packages/**/*.ts'
      - 'apps/**/*.ts'
      - 'services/**/*.ts'
      - '**/tsconfig*.json'
      - 'scripts/type-performance.ts'
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Performance threshold in seconds'
        required: false
        default: '1.0'
      generate_dashboard:
        description: 'Generate HTML dashboard'
        required: false
        default: 'true'

jobs:
  type-performance-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: styfle/cancel-workflow-action@0.12.1
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.0

      - name: ğŸ“¦ Install dependencies
        run: bun install --force

      - name: ğŸ” Type Performance Audit
        id: audit
        run: |
          bun run scripts/type-performance.ts audit \
            --json .type-analysis/audit-report.json \
            --threshold ${{ github.event.inputs.threshold || '1.0' }} \
            --graph
        continue-on-error: true

      - name: ğŸ“Š Generate Dashboard
        if: github.event.inputs.generate_dashboard != 'false'
        run: |
          bun run scripts/generate-dashboard.ts \
            --input .type-analysis/audit-report.json \
            --output .type-analysis/dashboard.html

      - name: ğŸ“¤ Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: type-performance-report
          path: |
            .type-analysis/audit-report.json
            .type-analysis/dashboard.html
          retention-days: 30

      - name: ğŸ“ Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('.type-analysis/audit-report.json', 'utf8'));
            
            const slowPackages = report.results.filter(r => r.durationSec > 1.0);
            const criticalPackages = report.results.filter(r => 
              r.errorType === 'recursion_limit' || r.errorType === 'oom'
            );
            const totalSlowFiles = report.results.reduce((sum, r) => sum + r.summary.slowFiles, 0);
            const typeHubs = report.results.reduce((sum, r) => sum + r.summary.typeHubFiles, 0);
            
            let status = 'âœ… All checks pass';
            if (criticalPackages.length > 0) status = 'ğŸ”¥ Critical issues found';
            else if (slowPackages.length > 0) status = 'âš ï¸ Performance warnings';
            
            const body = `## ğŸ“Š Type Performance Report
            
            **Status:** ${status}
            
            ### Summary
            - **Packages analyzed:** ${report.results.length}
            - **Slow packages (>1s):** ${slowPackages.length}
            - **Critical issues:** ${criticalPackages.length}
            - **Slow files:** ${totalSlowFiles}
            - **Type hubs:** ${typeHubs}
            
            ### Top 5 Slowest Packages
            ${report.results
              .sort((a, b) => b.durationSec - a.durationSec)
              .slice(0, 5)
              .map(r => `- **${r.name}:** ${r.durationSec.toFixed(2)}s ${
                r.errorType === 'recursion_limit' ? 'ğŸ”¥' :
                r.errorType === 'oom' ? 'ğŸ’¥' :
                r.durationSec > 2 ? 'âš ï¸' : 'âœ…'
              }`)
              .join('\n')}
            
            ${criticalPackages.length > 0 ? `
            ### ğŸš¨ Critical Issues
            ${criticalPackages.map(p => `- **${p.name}:** ${p.errorType}`).join('\n')}
            ` : ''}
            
            ${typeHubs > 0 ? `
            ### ğŸ“¦ Type Hubs Detected
            ${typeHubs} type hub files found. These cause cascade re-checks when modified.
            Run \`bun run scripts/type-performance.ts graph --package packages/db\` locally for details.
            ` : ''}
            
            <details>
            <summary>View full report</summary>
            
            Download the full [dashboard](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed analysis.
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: âŒ Check Budget
        if: steps.audit.outcome == 'failure'
        run: |
          echo "Type performance budget exceeded!"
          echo "Check the uploaded report for details."
          exit 1

  type-budget-check:
    runs-on: ubuntu-latest
    needs: type-performance-audit
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.0

      - name: ğŸ“¦ Install dependencies
        run: bun install --force

      - name: ğŸ“¥ Download baseline report
        uses: actions/download-artifact@v4
        with:
          name: type-performance-baseline
          path: .type-analysis/baseline
        continue-on-error: true

      - name: ğŸ” Compare with baseline
        if: hashFiles('.type-analysis/baseline/audit-report.json') != ''
        run: |
          bun run scripts/compare-type-performance.ts \
            --baseline .type-analysis/baseline/audit-report.json \
            --current .type-analysis/audit-report.json

  type-performance-baseline:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.0

      - name: ğŸ“¦ Install dependencies
        run: bun install --force

      - name: ğŸ” Generate baseline
        run: |
          bun run scripts/type-performance.ts audit \
            --json .type-analysis/audit-baseline.json \
            --threshold 1.0 \
            --graph

      - name: ğŸ“¤ Upload baseline
        uses: actions/upload-artifact@v4
        with:
          name: type-performance-baseline
          path: .type-analysis/audit-baseline.json
          retention-days: 90
