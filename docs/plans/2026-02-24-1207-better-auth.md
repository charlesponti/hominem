# Better Auth First-Principles Architecture (API + Web + Mobile + CLI)

> Superseded by: `docs/plans/2026-02-27-auth-consolidated-plan.md` (merged on 2026-02-27)

## Execution Tracker

### Latest Progress (2026-02-24)
- Implemented mobile Better Auth authorization-code bridge in API (`services/api/src/routes/auth.ts`):
  - `POST /api/auth/mobile/authorize` (Apple auth bootstrap + flow state storage)
  - `GET /api/auth/mobile/callback` (session-bound callback finalization + one-time exchange code issuance)
  - `POST /api/auth/mobile/exchange` (PKCE verifier validation + token pair delivery)
- Replaced mobile Supabase auth client with Better Auth PKCE token client in `apps/mobile/utils/better-auth-mobile.ts`:
  - PKCE verifier/challenge generation
  - system-browser callback parsing with state validation
  - refresh grant rotation path (`/api/auth/token`)
  - secure refresh token persistence via `expo-secure-store`
- Rewrote mobile auth state machine in `apps/mobile/utils/auth-provider.tsx`:
  - in-memory access-token session cache
  - proactive refresh scheduler (`T-120s` with jitter)
  - startup rehydration from secure refresh token
  - signed-out revocation path (`/api/auth/revoke`) and local secure wipe
- Removed mobile Supabase runtime config/dependency surface:
  - removed `@supabase/supabase-js` from `apps/mobile/package.json`
  - removed Supabase env keys from `apps/mobile/app.config.ts` and `apps/mobile/eas.json`
  - removed Supabase ATS exception domain from iOS build properties
- Simplified mobile login UI to Apple-only entrypoint in `apps/mobile/components/authentication/login-sheet.tsx`.
- Validation snapshot (2026-02-24, mobile phase):
  - `bun run --filter @hominem/api test -- src/middleware/auth.middleware.test.ts` -> pass (6/6)
  - `bunx tsc -p services/api/tsconfig.json --noEmit` -> no auth-route errors; blocked by pre-existing `packages/places` and `packages/services` issues
  - `bunx tsc -p apps/mobile/tsconfig.json --noEmit` -> no new auth-provider/better-auth-mobile type errors; blocked by pre-existing `apps/mobile/utils/local-store/sqlite.ts` and `packages/services` issues
- Implemented CLI loopback PKCE bridge endpoints in API (`services/api/src/routes/auth.ts`):
  - `POST /api/auth/cli/authorize`
  - `GET /api/auth/cli/callback`
  - `POST /api/auth/cli/exchange`
  - Added strict loopback redirect validation (`http://127.0.0.1|localhost:<port>`), PKCE verifier validation, and scope sanitization to allowed CLI scopes (`cli:read`, `cli:write`).
- Rewired CLI auth client (`tools/cli/src/utils/auth.ts`) to Better Auth contracts:
  - primary login now uses `/api/auth/cli/authorize` + browser loopback callback + `/api/auth/cli/exchange`
  - refresh path now uses OAuth-style `POST /api/auth/token` with `grant_type=refresh_token`
  - implemented functional device authorization fallback using `/api/auth/device/code` and `/api/auth/device/token` polling
- Updated CLI command ergonomics (`tools/cli/src/commands/auth.ts`):
  - added `hominem auth login --device` for headless/device flow
  - provider semantics standardized to Better Auth only
- Updated CLI secure-store schema (`tools/cli/src/utils/secure-store.ts`) to Better Auth provider model (`provider?: 'better-auth'`).
- Propagated refresh/session metadata across token surfaces:
  - `services/api/src/auth/session-store.ts` now returns `refreshFamilyId` on token issuance/rotation
  - `services/api/src/routes/auth.ts` now returns `session_id` and `refresh_family_id` on
    - `POST /api/auth/cli/exchange`
    - `POST /api/auth/mobile/exchange`
    - `POST /api/auth/token`
    - `POST /api/auth/refresh-token`
  - CLI token persistence now stores `sessionId`, `refreshFamilyId`, and `issuedAt`
- Updated CLI `auth status` semantics (`tools/cli/src/commands/auth.ts`) to report:
  - active vs expired token state
  - provider
  - TTL seconds and expiry timestamp
  - scopes
  - session id and refresh family id when present
- Validation snapshot (2026-02-24, CLI phase):
  - `bunx tsc -p tools/cli/tsconfig.json --noEmit` -> no CLI-local TS errors; blocked by pre-existing unrelated `packages/services` errors
  - `bun run --filter @hominem/api test -- src/middleware/auth.middleware.test.ts` -> pass (6/6)
- Added dedicated CLI bridge integration tests in `services/api/src/routes/auth.cli-bridge.test.ts` with deterministic module mocks (Better Auth API + Redis + subject/session issuers):
  - rejects non-loopback redirect URI on `POST /api/auth/cli/authorize`
  - validates successful authorize -> callback -> exchange loopback flow with PKCE
  - rejects PKCE verifier mismatch on `POST /api/auth/cli/exchange`
  - validation command: `bun run --filter @hominem/api test -- src/routes/auth.cli-bridge.test.ts src/middleware/auth.middleware.test.ts` -> pass (9/9)
- Added auth token response contract tests in `services/api/src/routes/auth.token-contract.test.ts`:
  - verifies `POST /api/auth/token` and `POST /api/auth/refresh-token` return
    `provider`, `session_id`, and `refresh_family_id` for refresh flows
  - verifies unsupported grant rejection on `POST /api/auth/token`
- Added CLI status semantics unit test in `tools/cli/src/commands/auth.status.test.ts`:
  - validates metadata-rich active status formatting and unauthenticated status messaging
  - validation command: `bunx vitest run src/commands/auth.status.test.ts` (from `tools/cli`) -> pass (2/2)
- Added CLI auth utility tests in `tools/cli/src/utils/auth.test.ts`:
  - validates expired-access refresh rotation path (`getAccessToken`) against `/api/auth/token`
  - validates device-code polling behavior for `authorization_pending` -> success transition
  - validates deterministic failure on `expired_token` during device polling
  - validation command: `bun run --filter @hominem/cli test` -> pass (5/5)
- Added CLI package test script in `tools/cli/package.json` (`\"test\": \"vitest run\"`) to standardize auth regression checks in CI/local loops.
- Added auth route rate limiting controls in `services/api/src/routes/auth.ts`:
  - `GET /api/auth/authorize` (IP-bucket)
  - `POST /api/auth/mobile/authorize` (IP-bucket)
  - `POST /api/auth/cli/authorize` (IP-bucket)
  - `POST /api/auth/token` and `POST /api/auth/refresh-token` (IP + refresh token key)
  - `POST /api/auth/device/code` (IP + client id key)
  - `POST /api/auth/device/token` (IP + client id + device code key)
  - fail-open behavior on cache failures to preserve auth availability
- Added rate-limit regression coverage in `services/api/src/routes/auth.rate-limit.test.ts`:
  - verifies repeated refresh-grant calls are throttled with `429 rate_limit_exceeded`
  - validation command: `bun run --filter @hominem/api test -- src/routes/auth.rate-limit.test.ts src/routes/auth.token-contract.test.ts src/routes/auth.cli-bridge.test.ts` -> pass (7/7)
- Implemented refresh token family rotation in `services/api/src/auth/session-store.ts` with one-time use semantics, replay detection, and family/session revocation.
- Wired `POST /api/auth/token` and `POST /api/auth/refresh-token` to refresh grant handling (`refresh_token`), plus `POST /api/auth/revoke` and session-aware `POST /api/auth/logout`.
- Enforced Apple-only primary sign-in in `GET /api/auth/authorize`; Google remains link-only and now requires authenticated context.
- Implemented passkey challenge store and passkey endpoints:
  - `POST /api/auth/passkey/register/options`
  - `POST /api/auth/passkey/register/verify`
  - `POST /api/auth/passkey/auth/options`
  - `POST /api/auth/passkey/auth/verify`
- Added revoked-session check in JWT middleware path (`services/api/src/middleware/auth.ts`).
- Added OAuth subject persistence helper (`services/api/src/auth/subjects.ts`) and moved Better Auth user resolution to `auth_subjects` mapping instead of synthetic `users.supabase_id` writes.
- Generated migration `packages/db/src/migrations/0059_sleepy_red_shift.sql` for auth tables and `users.primary_auth_subject_id`; fixed enum creation ordering for clean migration application.
- Verified DB migration path with `bun run --filter @hominem/db db:migrate:test` (success on 2026-02-24).
- Removed legacy API Supabase auth middleware file (`services/api/src/middleware/supabase.ts`) and removed Supabase auth dependencies from `services/api/package.json`.
- Added test-mode authenticated-header compatibility in `services/api/src/middleware/auth.ts` so existing API integration tests remain deterministic under the new auth gate.
- Added DB-backed constraint test `services/api/src/auth/subjects.constraint.test.ts` validating global uniqueness for linked Google identity (`provider + provider_subject`).
- Verified API integration test suite with `bun run --filter @hominem/api test` (9/9 passing on 2026-02-24).
- Removed active `users.supabase_id` query/write paths from `packages/auth/src/user-auth.service.ts`; Better Auth runtime now resolves identities through `auth_subjects` and ID/email only.
- Added Redis-backed revoked-session hot path in `services/api/src/auth/session-store.ts` with DB fallback and best-effort cache hydration.
- Pivoted to official Better Auth plugins in `services/api/src/auth/better-auth.ts`: `passkey`, `jwt`, `bearer`, `multi-session`, `one-time-token`, and `device-authorization`.
- Replaced custom passkey challenge/verification implementation with official plugin-backed route wrappers in `services/api/src/routes/auth.ts`; removed `services/api/src/auth/passkey-store.ts`.
- Installed official external plugin packages: `@better-auth/passkey` and `@better-auth/sso` (v1.4.19) in API workspace for plugin-based rollout.
- Implemented recommended plugin hardening set:
  - `api-key` with enforced key names, metadata enabled, expiry window policy, and per-key rate limiting defaults
  - `open-api` reference generation (`/api/better-auth/reference`)
  - `captcha` (env-gated) for high-risk auth endpoints (`/sign-in/social`, `/passkey/verify-authentication`, `/api-key/create`, etc.)
- Added auth env controls: `AUTH_CAPTCHA_PROVIDER` and `AUTH_CAPTCHA_SECRET_KEY`.
- Verified plugin rollout with `bun run --filter @hominem/api test` (9/9 passing on 2026-02-24).
- Implemented standardized auth bearer error taxonomy in `services/api/src/middleware/auth.ts`: `invalid_token`, `expired_token`, `invalid_audience`, `invalid_issuer`, `disallowed_kid`, `revoked_session`, `insufficient_scope`.
- Enforced deterministic bearer precedence: malformed/invalid bearer now fails fast with `401` and typed error payload (no silent fallback to cookie session).
- Added integration tests in `services/api/src/middleware/auth.middleware.test.ts` for malformed, expired, wrong-audience, and revoked-session bearer token rejection.
- Verified API test suite after hardening with `bun run --filter @hominem/api test` (13/13 passing on 2026-02-24).
- Added in-process bounded user cache in `services/api/src/middleware/auth.ts` (TTL + max entries) to eliminate repeated user hydration DB reads on bearer hot path.
- Upgraded revocation hot path in `services/api/src/auth/session-store.ts` to cache both session states (`active|revoked`) in Redis; steady-state checks now avoid DB fallback for active sessions.
- Expanded auth middleware integration tests to cover REST and RPC context contract behavior; verified with `bun run --filter @hominem/api test -- src/middleware/auth.middleware.test.ts` (6/6 passing on 2026-02-24).
- Verified full API suite with `bun run --filter @hominem/api test` (15/15 passing on 2026-02-24).
- Reworked middleware performance harness in `services/api/src/middleware/auth.perf.ts` to separate:
  - `auth_middleware_latency_ms` (middleware-only)
  - `auth_plus_db_handler_latency_ms` (middleware + DB route)
- Captured latest perf snapshot via `bun run --filter @hominem/api perf:auth-middleware`:
  - `auth_middleware_latency_ms`: p50 `0.307ms`, p95 `0.767ms`, p99 `1.536ms` (`targetMet: true`)
  - `auth_plus_db_handler_latency_ms`: p50 `0.949ms`, p95 `2.176ms`, p99 `3.03ms`
- Advanced `packages/auth` canonical API surface:
  - Added canonical `AuthProvider` and `useAuthContext` exports in `packages/auth/src/client.tsx`
  - Added canonical `AuthClient` type and `authClient` context field in `packages/auth/src/types.ts`
  - Added canonical `createServerAuthClient` helper in `packages/auth/src/server.ts`
  - Preserved `SupabaseAuthProvider`, `useSupabaseAuthContext`, and `createSupabaseServerClient` as compatibility aliases for in-flight app cutover
- Verified package auth type safety with `bun run --filter @hominem/auth typecheck` (success on 2026-02-24).
- Executed Phase 5 mechanical web cutover across `apps/finance`, `apps/notes`, and `apps/rocco`:
  - Replaced `useSupabaseAuthContext` usage with canonical `useAuthContext`
  - Replaced `SupabaseAuthProvider` with canonical `AuthProvider` in all app root providers
  - Replaced direct `supabase.auth.*` callsites with `authClient.auth.*`
  - Updated app server auth adapters to canonical `createServerAuthClient` (kept local alias export `createSupabaseServerClient` for compatibility)
  - Removed unused `@supabase/supabase-js` dependency from web app manifests (`apps/finance|notes|rocco/package.json`)
- Validation snapshot (2026-02-24):
  - `bun run --filter @hominem/finance typecheck` -> pass
  - `bun run --filter @hominem/notes typecheck` -> fails due pre-existing unrelated issues (`~/lib/rpc/notes-types` missing; `packages/services` TS errors)
  - `bun run --filter @hominem/rocco typecheck` -> fails due pre-existing unrelated `packages/services` TS errors
- Standardized OAuth callback behavior across web apps (`finance`, `notes`, `rocco`) in `app/routes/auth.callback.tsx`:
  - Canonicalized `next` redirect target to local relative paths only (rejects protocol-relative and absolute redirects)
  - Added deterministic provider error propagation (`error`, `error_description`) to app-local redirect target
  - Preserved Notes-specific default fallback (`/notes`) for callback failures
- Hardened Google link bootstrap route in Notes `app/routes/auth/google.tsx` by constraining `return_to` to local relative paths and using `/calendar` as safe default.
- Added authenticated Google-link state endpoint in API `GET /api/auth/link/google/status` (DB-backed `auth_subjects` lookup for active `provider='google'` link).
- Wired Notes calendar loader (`app/routes/calendar.tsx`) to consume `/api/auth/link/google/status` instead of hardcoded `hasGoogleAccount=true`, restoring correct link-required UX gating.
- Implemented shared cross-subdomain Better Auth session cookie controls in `services/api/src/auth/better-auth.ts`:
  - Configured strict `trustedOrigins` set (`BETTER_AUTH_URL`, `FINANCE_URL`, `NOTES_URL`, `ROCCO_URL`)
  - Added `advanced.useSecureCookies` policy derived from `NODE_ENV` and auth base URL protocol
  - Added `advanced.defaultCookieAttributes` with explicit `SameSite=Lax`, `HttpOnly`, and secure transport semantics
  - Added opt-in cross-subdomain cookie sharing via `advanced.crossSubDomainCookies` gated by `AUTH_COOKIE_DOMAIN`
- Added `AUTH_COOKIE_DOMAIN` environment surface in `services/api/src/env.ts` for explicit root-domain SSO cookie deployment.
- Confirmed Google is no longer a primary sign-in path on web clients; active web Google surface is restricted to authenticated linking route (`/auth/google` -> `/api/auth/link/google/start`) with server auth guard.
- Added API-side step-up grant enforcement for sensitive Google unlink operation in `services/api/src/routes/auth.ts`:
  - `POST /api/auth/passkey/auth/verify` now accepts optional `action` and issues short-lived step-up grants on successful passkey verification
  - `POST /api/auth/link/google/unlink` now requires and consumes a valid step-up grant for `action=google_unlink`
  - Returns deterministic `403 step_up_required` when grant is absent/expired
- Implemented client-side step-up in `packages/auth/src/client.tsx`:
  - `requireStepUp(action)` now executes full WebAuthn assertion flow (`/api/auth/passkey/auth/options` -> browser credential assertion -> `/api/auth/passkey/auth/verify`)
  - Added canonical `unlinkGoogle()` SDK helper that enforces `requireStepUp('google_unlink')` before calling `/api/auth/link/google/unlink`
  - Added WebAuthn/base64url normalization and serialization logic without adding external runtime dependencies
- Updated auth context contract in `packages/auth/src/types.ts` to include `unlinkGoogle`.
- Updated test compatibility mock in `apps/rocco/app/test/utils.tsx` for new auth context method.
- Removed remaining Supabase-compatibility auth surface from shared SDK/app adapters:
  - Removed `SupabaseAuthProvider`/`useSupabaseAuthContext` aliases from `packages/auth/src/client.tsx`
  - Removed `createSupabaseServerClient` shim from `packages/auth/src/server.ts`
  - Removed `SupabaseAuthUser`/`LegacySupabaseClient` and `HominemUser.supabaseId` from `packages/auth/src/types.ts`
  - Simplified `packages/auth/src/user.ts` to DB-row canonical mapping only (no Supabase payload mapper)
  - Removed Supabase-specific methods/signatures from `packages/auth/src/user-auth.service.ts`
  - Updated RPC context user mapping (`packages/hono-rpc/src/middleware/context.ts`) to canonical user shape (no `supabaseId`)
  - Updated web app server auth adapters to canonical-only export (`createServerAuthClient`) in `apps/finance|notes|rocco/app/lib/auth.server.ts`
- Validation snapshot (2026-02-24, post-hardening):
  - `bun run --filter @hominem/api test` -> pass (15/15)
  - `bun run --filter @hominem/finance typecheck` -> pass
  - `bun run --filter @hominem/notes typecheck` -> unchanged failures from pre-existing unrelated issues
  - `bun run --filter @hominem/rocco typecheck` -> unchanged failures from pre-existing unrelated `packages/services` issues
  - `bun run --filter @hominem/api test -- src/middleware/auth.middleware.test.ts src/auth/subjects.constraint.test.ts` -> pass (7/7)
  - `bun run --filter @hominem/auth typecheck` -> pass
  - `bun run --filter @hominem/api test -- src/middleware/auth.middleware.test.ts` -> pass (6/6)
- Verification status: auth changes compile; repository-wide typecheck is still blocked by pre-existing unrelated errors in `packages/services` and `packages/places`.

### Phase 0 - Program Controls And Baseline
- [ ] Create branch `codex/better-auth-rewrite`
- [ ] Create tracking issue with links to this plan and implementation PRs
- [ ] Capture baseline metrics: auth middleware p50/p95, login success rate, token refresh error rate
- [ ] Freeze auth-related feature work during rewrite window
- [ ] Add temporary CI guard: fail build on new `@supabase/*` auth imports

**Exit criteria**
- [ ] Baseline metrics recorded and published
- [ ] CI guard active and validated

### Phase 1 - Auth Core (Better Auth In API)
- [x] Add Better Auth server module in `services/api/src/auth/*`
- [x] Configure Apple OAuth as the only primary sign-in provider
- [x] Configure Google provider for link-only operations
- [x] Implement passkey registration/authentication endpoints and challenge store
- [x] Implement JWT issuance with claims: `iss aud sub sid jti scope role amr auth_time`
- [x] Implement JWKS endpoint `/.well-known/jwks.json`
- [x] Implement token revoke and session invalidate endpoints
- [x] Implement rotation-safe refresh token pipeline (one-time use)

**Exit criteria**
- [x] All auth core endpoints return expected schemas
- [ ] JWKS key discovery works from clean process startup
- [x] Refresh token replay triggers deterministic family revocation

### Phase 2 - Data Model And Persistence Rewrite
- [x] Add DB schema for `auth_subjects`
- [x] Add DB schema for `auth_sessions`
- [x] Add DB schema for `auth_refresh_tokens`
- [x] Add DB schema for `auth_passkeys`
- [x] Add DB schema for `auth_device_codes`
- [x] Refactor `users` schema to remove `supabase_id` dependency
- [x] Add indexes/constraints: provider uniqueness, token hash lookup, family lookup
- [ ] Add encryption-at-rest strategy for sensitive provider token material (if stored)

**Exit criteria**
- [x] Migrations apply cleanly on fresh database
- [x] Constraint tests validate global uniqueness for linked Google identity
- [x] No runtime path reads `supabase_id`

### Phase 3 - API Middleware And Authorization Plane
- [x] Replace `services/api/src/middleware/supabase.ts` with `services/api/src/middleware/auth.ts`
- [x] Implement local JWT verification with key cache and `kid` validation
- [x] Implement cookie + bearer extraction strategy with deterministic precedence
- [x] Implement session revocation check path (Redis-backed hot path + DB fallback)
- [x] Update Hono context shape to expose `auth` envelope
- [x] Update `packages/hono-rpc/src/middleware/auth.ts` to new context contracts
- [x] Add standardized auth error taxonomy (`invalid_token`, `expired_token`, `insufficient_scope`)

**Exit criteria**
- [x] Protected endpoints reject malformed, expired, revoked, and wrong-audience tokens
- [x] Context contract stable across REST and RPC paths
- [x] Middleware p95 overhead under target in local load harness

### Phase 4 - Shared Client SDK Rewrite (`packages/auth`)
- [x] Replace Supabase client/session abstractions with Better Auth client abstractions
- [x] Export canonical client API: `signInWithApple`, `linkGoogle`, `signOut`, `getSession`, `requireStepUp`
- [x] Remove Supabase-specific types from public interfaces
- [ ] Add CSRF + origin protection helpers for browser mutations
- [ ] Add auth event instrumentation hooks for telemetry

**Exit criteria**
- [x] `packages/auth` builds without `@supabase/*` runtime dependencies
- [ ] Public API consumed successfully by all three web apps in typecheck

### Phase 5 - Web Apps Cutover (`finance`, `notes`, `rocco`)
- [x] Replace all `supabase.auth.*` calls with `@hominem/auth` Better Auth calls
- [x] Standardize callback route handling for Apple auth code exchange
- [x] Implement shared cross-subdomain session cookie strategy
- [x] Restrict Google flows to authenticated link/unlink UI only
- [x] Remove any signup/login entry path using Google
- [x] Add step-up prompts for sensitive account mutations

**Exit criteria**
- [ ] Apple sign-in works in all web apps
- [ ] Existing authenticated session is recognized across all web app domains
- [ ] Google link is inaccessible while unauthenticated

### Phase 6 - Mobile Cutover (`apps/mobile`)
- [x] Replace `supabase-mobile.ts` with Better Auth PKCE client module (`better-auth-mobile.ts`)
- [x] Implement system-browser login and secure code exchange
- [x] Store refresh tokens in `expo-secure-store`; keep access token in memory cache
- [x] Implement background refresh scheduler with jitter and pre-expiry renewal
- [ ] Implement passkey step-up support for mobile-sensitive actions
- [x] Remove Supabase env surface from mobile runtime config

**Exit criteria**
- [ ] iOS and Android login flows complete without Supabase dependencies
- [ ] Token refresh survives app background/resume cycle
- [x] Mobile build config contains no Supabase auth variables

### Phase 7 - CLI Auth Rewrite (`tools/cli`)
- [x] Replace current auth provider model (`supabase|workos|unknown`) with Better Auth model
- [x] Keep loopback PKCE as primary path
- [x] Implement device code grant fallback for headless/SSH sessions
- [x] Update token exchange/refresh endpoints used by CLI
- [x] Update secure-store token schema (scopes, provider, expiry, refresh family metadata)
- [x] Update `auth status` and error messaging for new provider semantics

**Exit criteria**
- [ ] CLI login works in interactive browser environments
- [ ] Device code flow works in headless environment
- [x] CLI refresh path handles expired access tokens deterministically

### Phase 8 - Security Hardening And Operational Controls
- [ ] Integrate KMS-backed signing key management
- [ ] Implement automated key rotation with overlap window
- [x] Add auth endpoint rate limiting (IP + account + device code polling controls)
- [ ] Add OAuth redirect URI allowlist enforcement
- [ ] Add full audit event stream: login, link/unlink, revoke, replay, step-up
- [ ] Add incident playbook for key compromise and replay spike detection

**Exit criteria**
- [ ] Key rotation drill executed successfully
- [ ] Replay detection alerting validated
- [ ] Audit events visible in central telemetry backend

### Phase 9 - Verification, Benchmarking, And Decommission
- [ ] Run full auth unit test suite (token validation, replay logic, linking constraints)
- [ ] Run cross-surface integration tests (web/mobile/cli)
- [ ] Run security test matrix (CSRF, nonce/state mismatch, replay, scope escalation)
- [ ] Run load/perf benchmarks and confirm auth middleware p95 target
- [ ] Remove residual Supabase auth codepaths and env vars in API/web/mobile/CLI
- [ ] Remove Supabase auth docs and replace with Better Auth operational runbook

**Exit criteria**
- [ ] All auth-critical tests pass in CI
- [ ] `rg -n \"supabase auth|@supabase\" apps packages services tools/cli` shows no active auth usage
- [ ] Production readiness checklist signed off

### Cross-Phase Tracking Checklist
- [ ] Weekly security review of implemented auth diff
- [ ] Weekly performance regression report (auth middleware + refresh endpoints)
- [ ] Backlog triage for auth edge-case defects
- [ ] Update this tracker after each merged PR

## Summary
Design a single, self-hosted identity control plane inside `services/api` using Better Auth as the core authentication engine, with cryptographically strong, low-latency authorization primitives:

- Primary login: **Apple OAuth only**
- Post-signup account linking: **Google OAuth (1:1 globally unique link)**
- Session model: **rotating refresh token families + replay detection**
- Access model: **short-lived JWT access tokens (10 min) + JWKS**
- Step-up assurance: **passkeys for sensitive operations and recovery**
- Web SSO: **shared cross-subdomain session**
- CLI: **loopback PKCE primary + device-code fallback**
- Key management: **asymmetric signing keys in KMS with automatic rotation**

This removes Supabase from all auth-critical paths and optimizes for low per-request latency, strong compromise containment, and operational cost efficiency.

## Security And Performance Invariants
1. API authorization must be **O(1)** local JWT verification (no introspection network hop in steady state).
2. All refresh tokens are **single-use** and family-rotated; replay revokes the entire family.
3. OAuth state, PKCE verifier binding, and nonce are mandatory for every public client flow.
4. Session fixation and CSRF are blocked via strict cookie policy + origin validation + anti-CSRF token on mutation endpoints.
5. Sensitive actions require **step-up** (passkey assertion within recent auth window).
6. Google linking requires authenticated user context and explicit re-auth confirmation.

## Target Runtime Topology
## Component Graph
- `services/api`:
  - Better Auth server instance (auth endpoints, provider callbacks, session issuance)
  - Custom auth adjunct endpoints (CLI device code, JWKS, token exchange helpers)
  - Unified auth middleware for Hono RPC + REST routes
- `apps/finance`, `apps/notes`, `apps/rocco`:
  - Browser clients using Better Auth client SDK
  - Shared cookie-domain SSO across subdomains
- `apps/mobile`:
  - Authorization Code + PKCE via system browser (`expo-auth-session`)
  - Secure refresh token storage in `expo-secure-store`
- `tools/cli`:
  - Loopback PKCE browser auth
  - Device authorization grant fallback for headless terminals

## Cryptographic And Session Design
## Tokens
- Access token:
  - `alg`: `ES256` (or `EdDSA` if your KMS stack supports it cleanly)
  - TTL: `600s`
  - Claims: `iss`, `aud`, `sub`, `sid`, `jti`, `scope`, `role`, `amr`, `auth_time`
- Refresh token:
  - Opaque random 256-bit secret
  - Stored hashed (`SHA-256`) + peppered
  - Rotation on every refresh
  - Family ID + parent pointer for replay detection

## Key Lifecycle
- Private signing keys in KMS only
- JWKS endpoint publishes active public keys
- Rotation every 30 days; overlap window 7 days
- Emergency revoke: remove compromised `kid` and reject matching tokens by `kid` allowlist policy

## Data Model (replace existing Supabase-coupled auth fields)
## New/Updated Tables
1. `auth_subjects`
- `id` (uuid, pk), `user_id` (fk users.id), `provider` (`apple|google|passkey`)
- `provider_subject` (text), unique(provider, provider_subject)
- `linked_at`, `unlinked_at`, `is_primary`

2. `auth_sessions`
- `id` (uuid), `user_id`, `session_state`, `created_at`, `last_seen_at`, `revoked_at`
- `acr`/`amr`, `ip_hash`, `user_agent_hash`

3. `auth_refresh_tokens`
- `id`, `session_id`, `family_id`, `token_hash`, `parent_id`, `expires_at`, `used_at`, `revoked_at`
- index on `family_id`, `token_hash`

4. `auth_passkeys`
- `id`, `user_id`, `credential_id`, `public_key`, `sign_count`, `transports`, `created_at`, `last_used_at`
- unique(`credential_id`)

5. `auth_device_codes` (CLI fallback)
- `device_code_hash`, `user_code`, `client_id`, `scope`, `expires_at`, `interval_sec`, `status`, `subject_id`

6. `users` table changes
- Remove `supabase_id` dependence
- Add canonical `primary_auth_subject_id` (nullable until created)
- Keep `email`, `name`, `image`, `isAdmin`

## API / Interface Contracts
## Public Auth Endpoints (`services/api`)
- `GET /.well-known/jwks.json`
- `GET /api/auth/authorize` (OAuth 2.1 authorization endpoint wrapper)
- `POST /api/auth/token` (code exchange + refresh grant)
- `POST /api/auth/revoke`
- `GET /api/auth/session`
- `POST /api/auth/logout`
- `POST /api/auth/passkey/register/options`
- `POST /api/auth/passkey/register/verify`
- `POST /api/auth/passkey/auth/options`
- `POST /api/auth/passkey/auth/verify`
- `POST /api/auth/link/google/start`
- `GET /api/auth/link/google/callback`
- `POST /api/auth/link/google/unlink` (step-up required)
- `POST /api/auth/device/code`
- `POST /api/auth/device/token`

## Middleware Contract (replace Supabase middleware)
`services/api/src/middleware/auth.ts`:
- Input: bearer token or session cookie
- Output context:
  - `c.set('user')`
  - `c.set('userId')`
  - `c.set('auth') = { sub, sid, scope[], role, amr[], authTime }`
- Reject on invalid `aud`, expired `exp`, revoked `sid`, or disallowed `kid`

## Client Integration Contracts
- `packages/auth` becomes provider-agnostic Better Auth client package:
  - `signInWithApple()`
  - `linkGoogle()`
  - `signOut()`
  - `getSession()`
  - `requireStepUp(action)`
- Remove direct `supabase.auth.*` APIs from consumers.

## Web, Mobile, CLI Flow Definitions
## Web (finance/notes/rocco)
1. Browser initiates Apple auth with PKCE.
2. Callback sets secure session cookie on shared parent domain.
3. Apps perform silent session fetch and use bearer for API calls as needed.
4. Google link flow available only for authenticated users; no signup path via Google.

Cookie profile:
- `HttpOnly`, `Secure`, `SameSite=Lax` (Strict where viable for non-OAuth flows), domain shared across subdomains, rotation on refresh.

## Mobile (Expo)
1. System browser + PKCE authorization code flow.
2. Code exchange at API token endpoint.
3. Refresh token stored in `SecureStore`; access token in memory cache.
4. Background refresh with jitter and proactive renewal at T-120s.

## CLI
1. Default: loopback PKCE (`http://127.0.0.1:{port}/callback`).
2. Fallback: device code grant (`/device/code` + polling `/device/token`).
3. Tokens stored in OS keychain (`keytar`) with file fallback only when unavailable.
4. Scope-minimized CLI tokens (e.g., `cli:read`, `cli:write`).

## Hardening Controls
- Strict origin allowlist for all OAuth redirect URIs.
- OAuth callback parameter canonicalization and one-time state store.
- Refresh token replay detector with family revocation.
- Rate limits:
  - auth endpoints by IP + account key
  - passkey challenge endpoints
  - device code polling interval enforcement
- Audit log events:
  - login success/failure, provider link/unlink, session revoke, token replay, step-up pass/fail.
- PII minimization: hash IP/UA, never persist raw provider access tokens unless required; if required, envelope-encrypt at rest.

## Performance Design
- JWT verify entirely local using cached JWKS keyset (in-process LRU + periodic refresh).
- DB reads on steady authenticated requests limited to optional sid revocation cache check (Redis-backed).
- Redis as hot-path store:
  - revoked session ids
  - device code status
  - short-lived auth challenges
- Target p95 auth middleware overhead: <2 ms on warm path.

## Implementation Work Packages (full rewrite)
1. **Auth Core**
- Create Better Auth instance in `services/api/src/auth/*`
- Implement Apple provider and Google linking provider configuration
- Implement passkey plugin + step-up policy hooks

2. **Schema Rewrite**
- Introduce new auth tables above in `packages/db/src/schema/*`
- Remove `supabase_id` dependency and update relations/types

3. **Middleware Rewrite**
- Replace `services/api/src/middleware/supabase.ts` with JWT/session middleware
- Update Hono context types and `packages/hono-rpc` auth middleware inputs

4. **Client SDK Rewrite**
- Rebuild `packages/auth` around Better Auth client primitives
- Remove Supabase-specific types from exported interfaces

5. **Web App Rewrite**
- Replace all `supabase.auth.*` calls in `apps/finance|notes|rocco`
- Standardize callback route behavior and shared SSO cookie handling
- Keep Google connect UX only in post-auth account settings/integrations

6. **Mobile Rewrite**
- Replace `supabase-mobile.ts` with Better Auth token client
- Implement PKCE + secure storage + refresh scheduler

7. **CLI Rewrite**
- Replace current `/api/auth/token|refresh-token` coupling with new OAuth token + device grant endpoints
- Update provider enum and status output semantics

8. **Operational Controls**
- KMS-backed signing key service
- JWKS publishing and rotation automation
- Auth metrics + security audit stream

## Test Plan And Acceptance Criteria
## Unit
- JWT verify: alg/aud/iss/kid rejection matrix
- Refresh rotation: single-use and replay family revocation
- Provider linking constraints: one Google account globally unique
- Step-up gating on sensitive actions

## Integration
- Apple login success/failure and callback tampering cases
- Cross-subdomain SSO propagation across three web apps
- Mobile PKCE success and refresh renewal after app resume
- CLI loopback flow and device-code fallback behavior
- Revoked session immediately denied across API routes

## Security Tests
- CSRF on cookie mutation endpoints
- OAuth state/nonce mismatch rejection
- Token substitution and replay attempts
- Rate-limit evasion attempts on login and device polling

## Load Tests
- Auth middleware throughput with JWKS cache warm
- Refresh endpoint under concurrent mobile + CLI traffic
- Revocation propagation latency (Redis + API nodes)

## Acceptance Gates
- 100% auth-critical integration tests pass
- Zero usage of `@supabase/*` auth paths in `apps/*`, `services/api`, `packages/auth`
- p95 middleware overhead <2 ms at target load
- Replay attack test suite passes with family revocation evidence

## Assumptions And Defaults Chosen
- Better Auth is the core auth engine, embedded in `services/api`.
- Access token model: JWT + JWKS.
- Access token TTL: 10 minutes.
- Session strategy: rotating refresh token families.
- Web SSO: shared cross-subdomain sessions.
- Step-up assurance: passkeys for sensitive operations and recovery.
- Google linking policy: exactly one linked Google identity per user, globally unique.
- CLI auth: loopback PKCE primary, device-code fallback.
- Key custody: asymmetric signing keys in KMS with automated rotation.
