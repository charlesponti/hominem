<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Type Performance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      line-height: 1.6;
    }

    .header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header .timestamp {
      font-size: 0.875rem;
      color: #8b949e;
      margin-top: 0.25rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 1.5rem;
      transition: border-color 0.2s;
    }

    .metric-card:hover {
      border-color: #58a6ff;
    }

    .metric-card.critical {
      border-color: #f85149;
    }

    .metric-card.warning {
      border-color: #d29922;
    }

    .metric-label {
      font-size: 0.875rem;
      color: #8b949e;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 600;
      color: #f0f6fc;
    }

    .metric-status {
      font-size: 0.875rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
    }

    .status-good {
      background: #238636;
      color: #fff;
    }

    .status-warning {
      background: #9e6a03;
      color: #fff;
    }

    .status-critical {
      background: #da3633;
      color: #fff;
    }

    .section {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section h2 {
      font-size: 1.25rem;
      color: #f0f6fc;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 1rem;
    }

    .graph-container {
      height: 500px;
      background: #0d1117;
      border-radius: 6px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th {
      text-align: left;
      padding: 0.75rem;
      border-bottom: 1px solid #30363d;
      color: #8b949e;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      color: #f0f6fc;
    }

    td {
      padding: 0.75rem;
      border-bottom: 1px solid #21262d;
    }

    tr:hover td {
      background: #21262d;
    }

    .file-path {
      color: #58a6ff;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8125rem;
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-weight: 500;
    }

    .badge-hot {
      background: #da3633;
      color: #fff;
    }

    .badge-warm {
      background: #9e6a03;
      color: #fff;
    }

    .badge-cold {
      background: #238636;
      color: #fff;
    }

    .badge-barrel {
      background: #8957e5;
      color: #fff;
    }

    .recommendations {
      background: #0d1117;
      border-radius: 6px;
      padding: 1rem;
    }

    .recommendation {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      border-bottom: 1px solid #21262d;
    }

    .recommendation:last-child {
      border-bottom: none;
    }

    .recommendation-icon {
      font-size: 1.25rem;
    }

    .recommendation-text {
      flex: 1;
    }

    .recommendation-title {
      color: #f0f6fc;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .recommendation-desc {
      color: #8b949e;
      font-size: 0.875rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #30363d;
      padding-bottom: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }

    .tab:hover {
      background: #21262d;
    }

    .tab.active {
      background: #1f6feb;
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .node circle {
      stroke: #0d1117;
      stroke-width: 2px;
      cursor: pointer;
    }

    .node text {
      font-size: 10px;
      fill: #c9d1d9;
      pointer-events: none;
    }

    .link {
      stroke: #30363d;
      stroke-width: 1px;
    }

    .bar {
      fill: #58a6ff;
    }

    .bar:hover {
      fill: #79c0ff;
    }

    .tooltip {
      position: absolute;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 0.5rem;
      font-size: 0.8125rem;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
        <path d="M2 17l10 5 10-5"></path>
        <path d="M2 12l10 5 10-5"></path>
      </svg>
      Type Performance Dashboard
    </h1>
    <div class="timestamp" id="timestamp">Generated: Loading...</div>
  </div>

  <div class="container">
    <div class="metrics-grid" id="metrics">
      <!-- Metrics injected here -->
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="overview">Overview</div>
      <div class="tab" data-tab="files">Slow Files</div>
      <div class="tab" data-tab="graph">Dependency Graph</div>
      <div class="tab" data-tab="instantiations">Instantiations</div>
      <div class="tab" data-tab="recommendations">Recommendations</div>
    </div>

    <div class="tab-content active" id="overview">
      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 20v-6M6 20V10M18 20V4"></path>
          </svg>
          Package Performance
        </h2>
        <div class="chart-container">
          <canvas id="packageChart"></canvas>
        </div>
      </div>

      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          Type Checking Timeline
        </h2>
        <div class="chart-container">
          <canvas id="timelineChart"></canvas>
        </div>
      </div>
    </div>

    <div class="tab-content" id="files">
      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <path d="M14 2v6h6"></path>
          </svg>
          Slowest Files by Check Time
        </h2>
        <table id="filesTable">
          <thead>
            <tr>
              <th>File</th>
              <th>Package</th>
              <th>Check Time</th>
              <th>Instantiations</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="tab-content" id="graph">
      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="5" r="3"></circle>
            <circle cx="19" cy="10" r="3"></circle>
            <circle cx="5" cy="10" r="3"></circle>
            <circle cx="12" cy="19" r="3"></circle>
            <path d="M12 8v8"></path>
            <path d="M9 10l6 4"></path>
          </svg>
          Type Dependency Graph
        </h2>
        <div class="graph-container" id="graphVisualization"></div>
      </div>
    </div>

    <div class="tab-content" id="instantiations">
      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M2 12h20"></path>
          </svg>
          Top Instantiation Sites
        </h2>
        <div class="chart-container">
          <canvas id="instantiationChart"></canvas>
        </div>
      </div>
    </div>

    <div class="tab-content" id="recommendations">
      <div class="section">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          Actionable Recommendations
        </h2>
        <div class="recommendations" id="recommendationsList">
          <!-- Recommendations injected here -->
        </div>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    // Data will be injected here by the build script
    const TYPE_DATA = {{DATA_PLACEHOLDER}};

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof TYPE_DATA === 'undefined' || TYPE_DATA === null) {
        showError('No data available. Run type-performance.ts with --json first.');
        return;
      }

      renderDashboard(TYPE_DATA);
      setupTabs();
    });

    function showError(message) {
      document.body.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 1rem;">
          <div style="font-size: 3rem;">‚ö†Ô∏è</div>
          <div style="color: #f85149; font-size: 1.25rem;">${message}</div>
        </div>
      `;
    }

    function renderDashboard(data) {
      document.getElementById('timestamp').textContent = `Generated: ${new Date(data.generatedAt).toLocaleString()}`;

      renderMetrics(data);
      renderPackageChart(data);
      renderTimelineChart(data);
      renderFilesTable(data);
      renderGraph(data);
      renderInstantiationChart(data);
      renderRecommendations(data);
    }

    function renderMetrics(data) {
      const results = data.results || [];
      const totalFiles = results.reduce((sum, r) => sum + (r.summary?.totalFiles || 0), 0);
      const slowFiles = results.reduce((sum, r) => sum + (r.summary?.slowFiles || 0), 0);
      const totalInstantiations = results.reduce((sum, r) => sum + (r.summary?.totalInstantiations || 0), 0);
      const criticalPackages = results.filter(r => r.errorType === 'recursion_limit' || r.errorType === 'oom').length;
      const typeHubFiles = results.reduce((sum, r) => sum + (r.summary?.typeHubFiles || 0), 0);

      const avgTime = results.length > 0
        ? results.reduce((sum, r) => sum + r.durationSec, 0) / results.length
        : 0;

      const metrics = [
        {
          label: 'Total Files',
          value: totalFiles.toLocaleString(),
          status: 'good',
          statusText: 'Analyzed'
        },
        {
          label: 'Slow Files',
          value: slowFiles.toLocaleString(),
          status: slowFiles > 10 ? 'critical' : slowFiles > 0 ? 'warning' : 'good',
          statusText: slowFiles > 0 ? 'Needs Attention' : 'All Good'
        },
        {
          label: 'Avg Package Time',
          value: `${avgTime.toFixed(2)}s`,
          status: avgTime > 2 ? 'critical' : avgTime > 1 ? 'warning' : 'good',
          statusText: avgTime > 1 ? 'Above Budget' : 'Within Budget'
        },
        {
          label: 'Type Instantiations',
          value: `${(totalInstantiations / 1000).toFixed(0)}k`,
          status: totalInstantiations > 100000 ? 'critical' : totalInstantiations > 50000 ? 'warning' : 'good',
          statusText: totalInstantiations > 100000 ? 'High' : 'Normal'
        },
        {
          label: 'Type Hubs',
          value: typeHubFiles.toString(),
          status: typeHubFiles > 5 ? 'warning' : 'good',
          statusText: typeHubFiles > 0 ? 'Cascade Risk' : 'Healthy'
        },
        {
          label: 'Critical Issues',
          value: criticalPackages.toString(),
          status: criticalPackages > 0 ? 'critical' : 'good',
          statusText: criticalPackages > 0 ? 'Action Required' : 'No Issues'
        }
      ];

      const metricsContainer = document.getElementById('metrics');
      metricsContainer.innerHTML = metrics.map(m => `
        <div class="metric-card ${m.status}">
          <div class="metric-label">${m.label}</div>
          <div class="metric-value">${m.value}</div>
          <span class="metric-status status-${m.status}">${m.statusText}</span>
        </div>
      `).join('');
    }

    function renderPackageChart(data) {
      const results = data.results || [];
      const sorted = results.sort((a, b) => b.durationSec - a.durationSec).slice(0, 15);

      const ctx = document.getElementById('packageChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(r => r.name),
          datasets: [{
            label: 'Type Check Time (s)',
            data: sorted.map(r => r.durationSec),
            backgroundColor: sorted.map(r =>
              r.errorType === 'recursion_limit' ? '#f85149' :
              r.errorType === 'oom' ? '#da3633' :
              r.durationSec > 2 ? '#d29922' :
              '#238636'
            ),
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.raw.toFixed(2)}s`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#30363d' },
              ticks: { color: '#8b949e' }
            },
            x: {
              grid: { display: false },
              ticks: {
                color: '#8b949e',
                maxRotation: 45
              }
            }
          }
        }
      });
    }

    function renderTimelineChart(data) {
      const results = data.results || [];
      const sorted = results.sort((a, b) => a.durationSec - b.durationSec);

      const ctx = document.getElementById('timelineChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: sorted.map((_, i) => `Package ${i + 1}`),
          datasets: [{
            label: 'Cumulative Time',
            data: sorted.map((r, i) => sorted.slice(0, i + 1).reduce((s, p) => s + p.durationSec, 0)),
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            fill: true,
            tension: 0.4
          }, {
            label: 'Individual Time',
            data: sorted.map(r => r.durationSec),
            borderColor: '#f0883e',
            backgroundColor: 'rgba(240, 136, 62, 0.1)',
            fill: false,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#30363d' },
              ticks: { color: '#8b949e' }
            },
            x: {
              grid: { color: '#30363d' },
              ticks: { color: '#8b949e' }
            }
          }
        }
      });
    }

    function renderFilesTable(data) {
      const allFiles = (data.results || []).flatMap(r =>
        (r.files || []).map(f => ({
          ...f,
          package: r.name
        }))
      ).sort((a, b) => b.checkMs - a.checkMs).slice(0, 50);

      const tbody = document.querySelector('#filesTable tbody');
      tbody.innerHTML = allFiles.map(f => {
        const time = f.checkMs / 1000;
        const status = time > 2 ? 'critical' : time > 1 ? 'warning' : 'good';
        const badge = time > 2 ? 'badge-hot' : time > 1 ? 'badge-warm' : 'badge-cold';

        return `
          <tr>
            <td class="file-path">${f.path}</td>
            <td>${f.package}</td>
            <td>${time.toFixed(2)}s</td>
            <td>${f.instantiations?.toLocaleString() || 'N/A'}</td>
            <td><span class="badge ${badge}">${status}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderGraph(data) {
      const container = document.getElementById('graphVisualization');

      // Extract nodes and edges from type hubs data
      const nodes = [];
      const edges = [];
      const nodeSet = new Set();

      (data.results || []).forEach(pkg => {
        const allFiles = pkg.files || [];

        allFiles.forEach(f => {
          if (!nodeSet.has(f.path)) {
            nodeSet.add(f.path);
            nodes.push({
              id: f.path,
              name: f.path.split('/').pop(),
              group: pkg.name,
              centrality: f.instantiations || 0,
              isBarrel: f.suggestions?.some(s => s.includes('Barrel')) || false
            });
          }
        });

        // Create edges based on dependencies
        allFiles.forEach(f => {
          if (f.dependencies) {
            f.dependencies.forEach(dep => {
              if (nodeSet.has(dep)) {
                edges.push({ source: f.path, target: dep });
              }
            });
          }
        });
      });

      // Limit nodes for performance
      const limitedNodes = nodes.sort((a, b) => b.centrality - a.centrality).slice(0, 100);
      const nodeIds = new Set(limitedNodes.map(n => n.id));
      const limitedEdges = edges.filter(e => nodeIds.has(e.source) && nodeIds.has(e.target));

      // D3 force-directed graph
      const width = container.clientWidth;
      const height = container.clientHeight;

      const svg = d3.select('#graphVisualization')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      const simulation = d3.forceSimulation(limitedNodes)
        .force('link', d3.forceLink(limitedEdges).id(d => d.id).distance(50))
        .force('charge', d3.forceManyBody().strength(-100))
        .force('center', d3.forceCenter(width / 2, height / 2));

      const link = svg.append('g')
        .selectAll('line')
        .data(limitedEdges)
        .join('line')
        .attr('class', 'link');

      const node = svg.append('g')
        .selectAll('g')
        .data(limitedNodes)
        .join('g')
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      node.append('circle')
        .attr('r', d => Math.max(5, Math.min(20, Math.log(d.centrality + 1) * 2)))
        .attr('fill', d => d.isBarrel ? '#8957e5' : '#58a6ff');

      node.append('text')
        .attr('dx', 12)
        .attr('dy', 4)
        .text(d => d.name.length > 20 ? d.name.slice(0, 20) + '...' : d.name);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node
          .attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }

    function renderInstantiationChart(data) {
      const allFiles = (data.results || []).flatMap(r => r.files || []);
      const sorted = allFiles.sort((a, b) => (b.instantiations || 0) - (a.instantiations || 0)).slice(0, 20);

      const ctx = document.getElementById('instantiationChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(f => f.path.split('/').pop()),
          datasets: [{
            label: 'Type Instantiations',
            data: sorted.map(f => f.instantiations || 0),
            backgroundColor: sorted.map(f =>
              (f.instantiations || 0) > 10000 ? '#f85149' :
              (f.instantiations || 0) > 5000 ? '#d29922' :
              '#238636'
            ),
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: '#30363d' },
              ticks: { color: '#8b949e' }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#8b949e' }
            }
          }
        }
      });
    }

    function renderRecommendations(data) {
      const recommendations = [];
      const results = data.results || [];

      // Generate recommendations based on data
      const slowPackages = results.filter(r => r.durationSec > 2);
      if (slowPackages.length > 0) {
        recommendations.push({
          icon: 'üî•',
          title: `${slowPackages.length} packages exceed 2s type-check threshold`,
          desc: `Packages: ${slowPackages.map(p => p.name).join(', ')}. Consider splitting or optimizing these packages.`
        });
      }

      const highInstPackages = results.filter(r =>
        (r.summary?.totalInstantiations || 0) > 50000
      );
      if (highInstPackages.length > 0) {
        recommendations.push({
          icon: 'üîÅ',
          title: 'High type instantiation count detected',
          desc: `${highInstPackages.length} packages have >50k instantiations. Add explicit return types to reduce inference overhead.`
        });
      }

      const barrelFiles = results.flatMap(r =>
        (r.files || []).filter(f => f.suggestions?.some(s => s.includes('Barrel')))
      );
      if (barrelFiles.length > 0) {
        recommendations.push({
          icon: 'üì¶',
          title: `${barrelFiles.length} barrel files cause cascade re-checks`,
          desc: 'Replace barrel files with direct imports to improve IDE responsiveness.'
        });
      }

      const hubFiles = results.flatMap(r =>
        (r.files || []).filter(f => f.typeCentrality > 0.1)
      );
      if (hubFiles.length > 0) {
        recommendations.push({
          icon: 'üéØ',
          title: `${hubFiles.length} type hub files identified`,
          desc: 'These files are imported by many others. Changes trigger widespread re-type-checking.'
        });
      }

      const criticalErrors = results.filter(r => r.errorType === 'recursion_limit' || r.errorType === 'oom');
      if (criticalErrors.length > 0) {
        recommendations.push({
          icon: 'üí•',
          title: `${criticalErrors.length} packages have critical type errors`,
          desc: 'Recursion limit or OOM errors detected. Immediate action required to fix circular type references.'
        });
      }

      // Default recommendation if everything looks good
      if (recommendations.length === 0) {
        recommendations.push({
          icon: '‚úÖ',
          title: 'Type performance looks healthy!',
          desc: 'All packages are within performance budgets. Continue monitoring for regressions.'
        });
      }

      const container = document.getElementById('recommendationsList');
      container.innerHTML = recommendations.map(r => `
        <div class="recommendation">
          <div class="recommendation-icon">${r.icon}</div>
          <div class="recommendation-text">
            <div class="recommendation-title">${r.title}</div>
            <div class="recommendation-desc">${r.desc}</div>
          </div>
        </div>
      `).join('');
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.tab;

          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));

          tab.classList.add('active');
          document.getElementById(target).classList.add('active');
        });
      });
    }
  </script>
</body>
</html>
